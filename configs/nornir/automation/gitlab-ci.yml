stages:
  - validate
  - deploy

variables:
  NETBOX_URL: "http://192.168.117.135:8000"
  NETBOX_TOKEN: "c889397e6b09cfd1556378047213220b2c47b7e8"

# === FLUJO 1: DEPLOY AUTOMTICO (BGP Failover) ===
deploy_bgp_auto:
  stage: deploy
  tags:
    - nornir
  script:
    - echo " Desplegando cambios BGP autom谩ticamente desde NetBox..."
    - python3 apply_bgp_policies.py
  when: on_success
  only:
    variables:
      - $TRIGGERED_BY_NETBOX

# === FLUJO 2: VALIDACIN DE CONFIGURACIN COMPLETA ===
validate_full_config:
  stage: validate
  tags:
    - nornir
  script:
    - echo "И Validando configuraci贸n completa del router..."
    - if [ -f "configs/huawei-router.cfg" ]; then
        python3 scripts/validate_huawei_config.py configs/huawei-router.cfg;
      else
        echo "锔 No se encontr贸 archivo de configuraci贸n";
        exit 1;
      fi
  only:
    changes:
      - configs/huawei-router.cfg
    refs:
      - master
  except:
    variables:
      - $TRIGGERED_BY_NETBOX

# === FLUJO 3: DEPLOY MANUAL (Configuraci贸n completa) ===
deploy_full_config_manual:
  stage: deploy
  tags:
    - nornir
  script:
    - echo " Aplicando configuraci贸n completa del router..."
    - python3 scripts/apply_huawei_config.py
  when: manual
  only:
    changes:
      - configs/huawei-router.cfg
    refs:
      - master
  except:
    variables:
      - $TRIGGERED_BY_NETBOX
